<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Catálogo de Links do Google Docs</title>
    <!-- Inclui o Tailwind CSS para estilização responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter para todo o corpo do documento */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Cor de fundo suave */
        }
        /* Estilos para o botão de rolagem para o topo */
        #backToTopBtn {
            display: none; /* Escondido por padrão */
            position: fixed; /* Posição fixa na tela */
            bottom: 20px; /* 20px do fundo */
            right: 20px; /* 20px da direita */
            z-index: 99; /* Acima de outros elementos */
            border: none; /* Sem borda */
            outline: none; /* Sem contorno ao focar */
            background-color: #4f46e5; /* Cor de fundo do botão */
            color: white; /* Cor do texto */
            cursor: pointer; /* Cursor de ponteiro ao passar o mouse */
            padding: 15px; /* Preenchimento interno */
            border-radius: 50%; /* Borda arredondada para formar um círculo */
            font-size: 18px; /* Tamanho da fonte */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Sombra para profundidade */
            transition: background-color 0.3s ease; /* Transição suave na cor de fundo */
        }
        #backToTopBtn:hover {
            background-color: #4338ca; /* Cor de fundo mais escura ao passar o mouse */
        }
        /* Estilo para o modal de confirmação */
        .modal {
            display: none; /* Escondido por padrão */
            position: fixed; /* Posição fixa na tela */
            z-index: 100; /* Acima de tudo */
            left: 0;
            top: 0;
            width: 100%; /* Largura total */
            height: 100%; /* Altura total */
            overflow: auto; /* Habilita rolagem se necessário */
            background-color: rgba(0,0,0,0.4); /* Fundo semi-transparente */
            justify-content: center; /* Centraliza horizontalmente */
            align-items: center; /* Centraliza verticalmente */
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <header class="bg-indigo-700 text-white p-4 shadow-md">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold mb-2 md:mb-0 rounded-md">
                <span class="p-2 bg-indigo-800 rounded-md shadow-lg">Meu Catálogo de Links</span>
            </h1>
            <nav>
                <ul class="flex space-x-4">
                    <li>
                        <a href="#encontrar-links" id="tabEncontrarLinks" class="text-lg rounded-md p-2 bg-indigo-600 transition-colors duration-300">Encontrar Links</a>
                    </li>
                    <li>
                        <a href="#indicar-links" id="tabIndicarLinks" class="text-lg rounded-md p-2 hover:bg-indigo-600 transition-colors duration-300">Indicar Links</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow">
        <!-- Seção de Visualização Pública (Encontrar Links) -->
        <section id="public-view-section" class="bg-white p-6 rounded-lg shadow-xl">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Encontrar Links</h2>

            <div class="mb-6">
                <label for="publicSelectCategory" class="block text-gray-700 text-sm font-bold mb-2">Escolha uma Categoria:</label>
                <select id="publicSelectCategory" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">Selecione uma Categoria</option>
                </select>
            </div>

            <div class="mb-6">
                <label for="publicSelectSubcategory" class="block text-gray-700 text-sm font-bold mb-2">Escolha uma Subcategoria:</label>
                <select id="publicSelectSubcategory" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">Selecione uma Subcategoria</option>
                </select>
            </div>

            <button id="searchArticlesBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 mb-6">
                Buscar Artigos
            </button>

            <div id="publicLinksDisplay" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Links filtrados serão exibidos aqui -->
                <p id="publicNoLinksMessage" class="text-gray-500 text-center col-span-full">Carregando dados...</p>
                <p id="publicLoadingMessage" class="text-gray-500 text-center col-span-full hidden"></p>
            </div>
        </section>

        <!-- Seção de Administração (Indicar Links) -->
        <section id="admin-section" class="bg-white p-6 rounded-lg shadow-xl mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Indicar Links (Painel de Administração)</h2>

            <!-- Adicionar Categoria -->
            <div class="mb-6 border-b pb-4">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Gerenciar Categorias</h3>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="text" id="newCategoryName" placeholder="Nome da nova categoria" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="addCategoryBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">
                        Adicionar Categoria
                    </button>
                </div>
                <div id="categoryListAdmin" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Categorias administráveis serão listadas aqui -->
                </div>
            </div>

            <!-- Adicionar Subcategoria -->
            <div class="mb-6 border-b pb-4">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Gerenciar Subcategorias</h3>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <select id="selectCategoryForSub" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Selecione uma Categoria</option>
                    </select>
                    <input type="text" id="newSubcategoryName" placeholder="Nome da nova subcategoria" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="addSubcategoryBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">
                        Adicionar Subcategoria
                    </button>
                </div>
                <div id="subcategoryListAdmin" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Subcategorias administráveis serão listadas aqui -->
                </div>
            </div>

            <!-- Adicionar Link -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Novo Link</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="selectCategoryForLink" class="block text-gray-700 text-sm font-bold mb-2">Categoria:</label>
                        <select id="selectCategoryForLink" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">Selecione uma Categoria</option>
                        </select>
                    </div>
                    <div>
                        <label for="selectSubcategoryForLink" class="block text-gray-700 text-sm font-bold mb-2">Subcategoria:</label>
                        <select id="selectSubcategoryForLink" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">Selecione uma Subcategoria</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="linkTitle" class="block text-gray-700 text-sm font-bold mb-2">Título do Documento:</label>
                        <input type="text" id="linkTitle" placeholder="Ex: Relatório Mensal" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="linkUrl" class="block text-gray-700 text-sm font-bold mb-2">URL do Google Doc:</label>
                        <input type="url" id="linkUrl" placeholder="Ex: https://docs.google.com/document/d/..." class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <button id="addLinkBtn" class="mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">
                    Adicionar Link
                </button>
            </div>
            <div id="messageBoxAdmin" class="mt-4 p-3 text-sm text-center rounded-lg hidden"></div>
        </section>
    </main>

    <footer class="bg-indigo-700 text-white p-4 text-center mt-8 shadow-inner">
        <p>&copy; 2025 Meu Catálogo de Links. Todos os direitos reservados.</p>
    </footer>

    <!-- Botão de rolagem para o topo -->
    <button id="backToTopBtn" title="Voltar ao Topo">
        &#9650; <!-- Seta para cima -->
    </button>

    <!-- Modal de Confirmação -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modalMessage" class="mb-4 text-lg"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirmYesBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sim</button>
                <button id="confirmNoBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Não</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importa as funções necessárias do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, orderBy, onSnapshot, addDoc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais fornecidas pelo ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Inicializa o Firebase
        let app;
        let db;
        let auth;
        let currentUser = null; // Usado para operações de Firestore
        let currentUserId = null;
        let isAuthReady = false; // Flag para indicar se a autenticação foi inicializada

        // Referências aos elementos do DOM
        const tabEncontrarLinks = document.getElementById('tabEncontrarLinks');
        const tabIndicarLinks = document.getElementById('tabIndicarLinks');
        const publicViewSection = document.getElementById('public-view-section');
        const adminSection = document.getElementById('admin-section');
        const backToTopBtn = document.getElementById('backToTopBtn');
        const messageBoxAdmin = document.getElementById('messageBoxAdmin');

        // Elementos do painel de administração
        const newCategoryNameInput = document.getElementById('newCategoryName');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const categoryListAdmin = document.getElementById('categoryListAdmin');

        const selectCategoryForSub = document.getElementById('selectCategoryForSub');
        const newSubcategoryNameInput = document.getElementById('newSubcategoryName');
        const addSubcategoryBtn = document.getElementById('addSubcategoryBtn');
        const subcategoryListAdmin = document.getElementById('subcategoryListAdmin');

        const selectCategoryForLink = document.getElementById('selectCategoryForLink');
        const selectSubcategoryForLink = document.getElementById('selectSubcategoryForLink');
        const linkTitleInput = document.getElementById('linkTitle');
        const linkUrlInput = document.getElementById('linkUrl');
        const addLinkBtn = document.getElementById('addLinkBtn');

        // Elementos da visualização pública
        const publicSelectCategory = document.getElementById('publicSelectCategory');
        const publicSelectSubcategory = document.getElementById('publicSelectSubcategory');
        const searchArticlesBtn = document.getElementById('searchArticlesBtn');
        const publicLinksDisplay = document.getElementById('publicLinksDisplay');
        const publicNoLinksMessage = document.getElementById('publicNoLinksMessage');
        const publicLoadingMessage = document.getElementById('publicLoadingMessage');

        // Modal de confirmação
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');
        const closeModalBtn = document.querySelector('.close-button');

        let confirmActionCallback = null; // Callback para a ação a ser confirmada

        // Função para exibir o modal de confirmação
        function showConfirmationModal(message, callback) {
            modalMessage.textContent = message;
            confirmActionCallback = callback;
            confirmationModal.style.display = 'flex'; // Usa flex para centralizar
        }

        // Event listeners para o modal
        confirmYesBtn.addEventListener('click', () => {
            if (confirmActionCallback) {
                confirmActionCallback(true);
            }
            confirmationModal.style.display = 'none';
        });

        confirmNoBtn.addEventListener('click', () => {
            if (confirmActionCallback) {
                confirmActionCallback(false);
            }
            confirmationModal.style.display = 'none';
        });

        closeModalBtn.addEventListener('click', () => {
            confirmationModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === confirmationModal) {
                confirmationModal.style.display = 'none';
            }
        });

        // Estrutura para armazenar os dados do Firestore
        let allCategories = []; // Array de objetos de categoria com suas subcategorias e links

        // Função para exibir mensagens ao usuário (no painel de administração)
        function showMessage(message, type = 'info') {
            messageBoxAdmin.textContent = message;
            messageBoxAdmin.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-blue-100', 'text-blue-700');
            if (type === 'success') {
                messageBoxAdmin.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                messageBoxAdmin.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBoxAdmin.classList.add('bg-blue-100', 'text-blue-700');
            }
            setTimeout(() => {
                messageBoxAdmin.classList.add('hidden');
            }, 3000);
        }

        // --- Funções de Interação com Firestore ---

        // Adicionar Categoria
        async function addCategory() {
            const name = newCategoryNameInput.value.trim();
            if (!name) {
                showMessage('Por favor, insira um nome para a categoria.', 'error');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/categories`), {
                    name: name,
                    createdAt: new Date(),
                    userId: currentUserId // Associa a categoria ao usuário Firebase anônimo
                });
                showMessage('Categoria adicionada com sucesso!', 'success');
                newCategoryNameInput.value = '';
                // Força a atualização dos dados após a adição
                listenForCategories();
            } catch (e) {
                console.error("Erro ao adicionar categoria: ", e);
                showMessage('Erro ao adicionar categoria.', 'error');
            }
        }

        // Deletar Categoria
        async function deleteCategory(categoryId) {
            showConfirmationModal('Tem certeza que deseja excluir esta categoria e todo o seu conteúdo (subcategorias e links)?', async (confirmed) => {
                if (confirmed) {
                    try {
                        // Para deletar uma categoria, precisamos deletar suas subcoleções (subcategorias e links)
                        // Firestore não deleta subcoleções automaticamente.
                        // Primeiro, pegamos todas as subcategorias
                        const subcategoriesQuery = query(collection(db, `artifacts/${appId}/public/data/categories/${categoryId}/subcategories`));
                        const subcategoriesSnapshot = await getDocs(subcategoriesQuery);

                        for (const subDoc of subcategoriesSnapshot.docs) {
                            const subcategoryId = subDoc.id;
                            // Para cada subcategoria, pegamos todos os links
                            const linksQuery = query(collection(db, `artifacts/${appId}/public/data/categories/${categoryId}/subcategories/${subcategoryId}/links`));
                            const linksSnapshot = await getDocs(linksQuery);
                            for (const linkDoc of linksSnapshot.docs) {
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/categories/${categoryId}/subcategories/${subcategoryId}/links`, linkDoc.id));
                            }
                            // Deleta a subcategoria
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/categories/${categoryId}/subcategories`, subcategoryId));
                        }
                        // Finalmente, deleta a categoria
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/categories`, categoryId));
                        showMessage('Categoria e conteúdo deletados com sucesso!', 'success');
                        // Força a atualização dos dados após a exclusão
                        listenForCategories();
                    } catch (e) {
                        console.error("Erro ao deletar categoria: ", e);
                        showMessage('Erro ao deletar categoria.', 'error');
                    }
                }
            });
        }

        // Adicionar Subcategoria
        async function addSubcategory() {
            const categoryId = selectCategoryForSub.value;
            const name = newSubcategoryNameInput.value.trim();
            if (!categoryId || !name) {
                showMessage('Por favor, selecione uma categoria e insira um nome para a subcategoria.', 'error');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/categories/${categoryId}/subcategories`), {
                    name: name,
                    createdAt: new Date(),
                    userId: currentUserId
                });
                showMessage('Subcategoria adicionada com sucesso!', 'success');
                newSubcategoryNameInput.value = '';
                // Força a atualização dos dados após a adição
                listenForCategories();
            } catch (e) {
                console.error("Erro ao adicionar subcategoria: ", e);
                showMessage('Erro ao adicionar subcategoria.', 'error');
            }
        }

        // Deletar Subcategoria
        async function deleteSubcategory(categoryId, subcategoryId) {
            showConfirmationModal('Tem certeza que deseja excluir esta subcategoria e todos os seus links?', async (confirmed) => {
                if (confirmed) {
                    try {
                        // Primeiro, pegamos todos os links da subcategoria
                        const linksQuery = query(collection(db, `artifacts/${appId}/public/data/categories/${categoryId}/subcategories/${subcategoryId}/links`));
                        const linksSnapshot = await getDocs(linksQuery);
                        for (const linkDoc of linksSnapshot.docs) {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/categories/${categoryId}/subcategories/${subcategoryId}/links`, linkDoc.id));
                        }
                        // Depois, deleta a subcategoria
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/categories/${categoryId}/subcategories`, subcategoryId));
                        showMessage('Subcategoria e links deletados com sucesso!', 'success');
                        // Força a atualização dos dados após a exclusão
                        listenForCategories();
                    } catch (e) {
                        console.error("Erro ao deletar subcategoria: ", e);
                        showMessage('Erro ao deletar subcategoria.', 'error');
                    }
                }
            });
        }

        // Adicionar Link
        async function addLink() {
            const categoryId = selectCategoryForLink.value;
            const subcategoryId = selectSubcategoryForLink.value;
            const title = linkTitleInput.value.trim();
            const url = linkUrlInput.value.trim();

            if (!categoryId || !subcategoryId || !title || !url) {
                showMessage('Por favor, selecione uma categoria e subcategoria, e preencha o título e a URL.', 'error');
                return;
            }

            if (!url.startsWith('https://docs.google.com/document/')) {
                showMessage('Por favor, insira uma URL válida do Google Docs.', 'error');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/categories/${categoryId}/subcategories/${subcategoryId}/links`), {
                    title: title,
                    url: url,
                    createdAt: new Date(),
                    userId: currentUserId
                });
                showMessage('Link adicionado com sucesso!', 'success');
                linkTitleInput.value = '';
                linkUrlInput.value = '';
                // Força a atualização dos dados após a adição
                listenForCategories();
            } catch (e) {
                console.error("Erro ao adicionar link: ", e);
                showMessage('Erro ao adicionar link.', 'error');
            }
        }

        // Deletar Link
        async function deleteLink(categoryId, subcategoryId, linkId) {
            showConfirmationModal('Tem certeza que deseja excluir este link?', async (confirmed) => {
                if (confirmed) {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/categories/${categoryId}/subcategories/${subcategoryId}/links`, linkId));
                        showMessage('Link deletado com sucesso!', 'success');
                        // Força a atualização dos dados após a exclusão
                        listenForCategories();
                    } catch (e) {
                        console.error("Erro ao deletar link: ", e);
                        showMessage('Erro ao deletar link.', 'error');
                    }
                }
            });
        }

        // --- Funções de Renderização da UI ---

        // Renderiza o painel de administração
        function renderAdminPanel() {
            categoryListAdmin.innerHTML = '';
            subcategoryListAdmin.innerHTML = '';
            selectCategoryForSub.innerHTML = '<option value="">Selecione uma Categoria</option>';
            selectCategoryForLink.innerHTML = '<option value="">Selecione uma Categoria</option>';
            selectSubcategoryForLink.innerHTML = '<option value="">Selecione uma Subcategoria</option>';

            allCategories.forEach(category => {
                // Renderizar categorias para administração
                const categoryCard = document.createElement('div');
                categoryCard.className = 'bg-indigo-50 p-3 rounded-lg shadow-sm flex justify-between items-center';
                categoryCard.innerHTML = `
                    <span class="font-medium">${category.name}</span>
                    <button class="text-red-500 hover:text-red-700 delete-category-btn" data-id="${category.id}">Excluir</button>
                `;
                categoryCard.querySelector('.delete-category-btn').addEventListener('click', () => deleteCategory(category.id));
                categoryListAdmin.appendChild(categoryCard);

                // Popular dropdowns de seleção de categoria
                const optionForSub = document.createElement('option');
                optionForSub.value = category.id;
                optionForSub.textContent = category.name;
                selectCategoryForSub.appendChild(optionForSub);

                const optionForLink = document.createElement('option');
                optionForLink.value = category.id;
                optionForLink.textContent = category.name;
                selectCategoryForLink.appendChild(optionForLink);

                // Renderizar subcategorias para administração
                category.subcategories.forEach(sub => {
                    const subcategoryCard = document.createElement('div');
                    subcategoryCard.className = 'bg-blue-50 p-3 rounded-lg shadow-sm flex justify-between items-center';
                    subcategoryCard.innerHTML = `
                        <span class="font-medium">${category.name} > ${sub.name}</span>
                        <button class="text-red-500 hover:text-red-700 delete-subcategory-btn" data-category-id="${category.id}" data-id="${sub.id}">Excluir</button>
                    `;
                    subcategoryCard.querySelector('.delete-subcategory-btn').addEventListener('click', () => deleteSubcategory(category.id, sub.id));
                    subcategoryListAdmin.appendChild(subcategoryCard);
                });
            });
        }

        // Renderiza a visualização pública
        function renderPublicView() {
            publicLinksDisplay.innerHTML = '';
            publicLoadingMessage.classList.add('hidden'); // Esconde a mensagem de carregamento inicialmente

            if (allCategories.length === 0) {
                publicNoLinksMessage.textContent = 'Nenhum conteúdo adicionado ainda. Se você é o administrador, adicione categorias, subcategorias e links no painel de administração.';
                publicNoLinksMessage.classList.remove('hidden');
            } else {
                publicNoLinksMessage.classList.add('hidden'); // Esconde se houver conteúdo
            }

            // Popula o dropdown de categorias públicas
            publicSelectCategory.innerHTML = '<option value="">Selecione uma Categoria</option>';
            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                publicSelectCategory.appendChild(option);
            });

            // Limpa o dropdown de subcategorias públicas
            publicSelectSubcategory.innerHTML = '<option value="">Selecione uma Subcategoria</option>';
        }

        // Função para alternar entre as abas e atualizar seus estilos
        function showTab(tabId) {
            // Remove o estilo ativo de ambas as abas
            tabEncontrarLinks.classList.remove('bg-indigo-600');
            tabEncontrarLinks.classList.add('hover:bg-indigo-600');
            tabIndicarLinks.classList.remove('bg-indigo-600');
            tabIndicarLinks.classList.add('hover:bg-indigo-600');

            // Esconde ambas as seções de conteúdo
            publicViewSection.classList.add('hidden');
            adminSection.classList.add('hidden');

            // Mostra a seção de conteúdo selecionada e adiciona o estilo ativo à aba
            if (tabId === 'encontrar-links') {
                publicViewSection.classList.remove('hidden');
                tabEncontrarLinks.classList.add('bg-indigo-600');
                tabEncontrarLinks.classList.remove('hover:bg-indigo-600');
            } else if (tabId === 'indicar-links') {
                adminSection.classList.remove('hidden');
                tabIndicarLinks.classList.add('bg-indigo-600');
                tabIndicarLinks.classList.remove('hover:bg-indigo-600');
            }
        }

        // Atualiza os dropdowns de subcategorias ao selecionar uma categoria (para admin e público)
        selectCategoryForLink.addEventListener('change', () => {
            const selectedCategoryId = selectCategoryForLink.value;
            selectSubcategoryForLink.innerHTML = '<option value="">Selecione uma Subcategoria</option>';
            if (selectedCategoryId) {
                const category = allCategories.find(cat => cat.id === selectedCategoryId);
                if (category) {
                    category.subcategories.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub.id;
                        option.textContent = sub.name;
                        selectSubcategoryForLink.appendChild(option);
                    });
                }
            }
        });

        // Event listener para seleção de categoria na visão pública
        publicSelectCategory.addEventListener('change', () => {
            const selectedCategoryId = publicSelectCategory.value;
            publicSelectSubcategory.innerHTML = '<option value="">Selecione uma Subcategoria</option>';
            if (selectedCategoryId) {
                const category = allCategories.find(cat => cat.id === selectedCategoryId);
                if (category) {
                    category.subcategories.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub.id;
                        option.textContent = sub.name;
                        publicSelectSubcategory.appendChild(option);
                    });
                }
            }
            // Limpa os links exibidos quando a categoria muda
            publicLinksDisplay.innerHTML = '';
            publicNoLinksMessage.textContent = 'Selecione uma subcategoria para buscar artigos.';
            publicNoLinksMessage.classList.remove('hidden');
        });

        // Event listener para o botão "Buscar Artigos" na visão pública
        searchArticlesBtn.addEventListener('click', () => {
            const selectedCategoryId = publicSelectCategory.value;
            const selectedSubcategoryId = publicSelectSubcategory.value;

            publicLinksDisplay.innerHTML = ''; // Limpa resultados anteriores
            publicNoLinksMessage.classList.add('hidden');
            publicLoadingMessage.classList.remove('hidden'); // Mostra mensagem de carregamento

            if (!selectedCategoryId || !selectedSubcategoryId) {
                publicLoadingMessage.classList.add('hidden');
                publicNoLinksMessage.textContent = 'Por favor, selecione uma categoria e uma subcategoria.';
                publicNoLinksMessage.classList.remove('hidden');
                return;
            }

            const category = allCategories.find(cat => cat.id === selectedCategoryId);
            if (category) {
                const subcategory = category.subcategories.find(sub => sub.id === selectedSubcategoryId);
                if (subcategory && subcategory.links.length > 0) {
                    subcategory.links.forEach(link => {
                        const linkCard = document.createElement('div');
                        linkCard.className = 'bg-gray-50 p-4 rounded-lg shadow-sm flex flex-col justify-between transform hover:scale-105 transition-transform duration-300';
                        linkCard.innerHTML = `
                            <div>
                                <h5 class="font-bold text-md text-gray-900 mb-1 truncate">${link.title}</h5>
                                <p class="text-gray-600 text-xs mb-2 truncate">${link.url}</p>
                            </div>
                            <div class="flex justify-between items-center mt-auto">
                                <a href="${link.url}" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm transition-colors duration-300">
                                    Abrir Doc
                                </a>
                                <!-- Botão de exclusão visível apenas na aba "Indicar Links" -->
                                ${adminSection.classList.contains('hidden') ? '' : `<button class="delete-link-btn text-red-500 hover:text-red-700 transition-colors duration-300 text-sm" data-category-id="${category.id}" data-subcategory-id="${subcategory.id}" data-link-id="${link.id}">
                                    Excluir
                                </button>`}
                            </div>
                        `;
                        // Adiciona o listener apenas se o botão de exclusão estiver presente
                        if (!adminSection.classList.contains('hidden')) {
                            linkCard.querySelector('.delete-link-btn').addEventListener('click', (event) => {
                                const catId = event.target.dataset.categoryId;
                                const subId = event.target.dataset.subcategoryId;
                                const linkId = event.target.dataset.linkId;
                                deleteLink(catId, subId, linkId);
                            });
                        }
                        publicLinksDisplay.appendChild(linkCard);
                    });
                    publicLoadingMessage.classList.add('hidden');
                } else {
                    publicLoadingMessage.classList.add('hidden');
                    publicNoLinksMessage.textContent = 'Nenhum artigo encontrado para esta subcategoria.';
                    publicNoLinksMessage.classList.remove('hidden');
                }
            } else {
                publicLoadingMessage.classList.add('hidden');
                publicNoLinksMessage.textContent = 'Nenhum artigo encontrado para a seleção.';
                publicNoLinksMessage.classList.remove('hidden');
            }
        });

        // --- Configuração e Observadores do Firebase ---

        // Função para configurar o Firebase e observar as mudanças de autenticação
        async function setupFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Faz login anonimamente para permitir leitura pública e escrita (conforme regras do Firestore)
                    const userCredential = await signInAnonymously(auth);
                    currentUser = userCredential.user;
                    currentUserId = currentUser.uid; // Pega o UID do usuário anônimo

                    isAuthReady = true;
                    // Uma vez que a autenticação está pronta, comece a ouvir os dados
                    listenForCategories();
                } else {
                    // Caso não haja configuração do Firebase, exibe mensagem de erro
                    publicLoadingMessage.textContent = 'Configuração do Firebase ausente. Não é possível carregar dados.';
                    publicNoLinksMessage.classList.remove('hidden');
                    publicLoadingMessage.classList.add('hidden');
                    isAuthReady = true; // Marca como pronto mesmo sem Firebase para evitar loop de carregamento
                }
            } catch (error) {
                console.error("Erro ao inicializar Firebase ou autenticar:", error);
                publicLoadingMessage.textContent = 'Erro ao carregar dados. Verifique o console para detalhes.';
                publicNoLinksMessage.classList.remove('hidden');
                publicLoadingMessage.classList.add('hidden');
            }
        }

        // Observador de dados do Firestore
        function listenForCategories() {
            if (!db || !isAuthReady) return; // Garante que o Firebase está pronto

            const categoriesRef = collection(db, `artifacts/${appId}/public/data/categories`);
            const q = query(categoriesRef, orderBy('createdAt')); // Ordena por data de criação

            onSnapshot(q, async (categorySnapshot) => {
                const fetchedCategories = [];
                // Para cada categoria, buscamos suas subcategorias e links
                for (const categoryDoc of categorySnapshot.docs) {
                    const categoryData = { id: categoryDoc.id, ...categoryDoc.data(), subcategories: [] };
                    
                    const subcategoriesRef = collection(db, `artifacts/${appId}/public/data/categories/${categoryDoc.id}/subcategories`);
                    const subQ = query(subcategoriesRef, orderBy('createdAt'));
                    const subcategorySnapshot = await getDocs(subQ); // Usar getDocs para buscar todas de uma vez

                    const fetchedSubcategories = [];
                    for (const subDoc of subcategorySnapshot.docs) {
                        const subcategoryData = { id: subDoc.id, ...subDoc.data(), links: [] };

                        const linksRef = collection(db, `artifacts/${appId}/public/data/categories/${categoryDoc.id}/subcategories/${subDoc.id}/links`);
                        const linkQ = query(linksRef, orderBy('createdAt'));
                        const linkSnapshot = await getDocs(linkQ); // Usar getDocs para buscar todas de uma vez

                        linkSnapshot.forEach(linkDoc => {
                            subcategoryData.links.push({ id: linkDoc.id, ...linkDoc.data() });
                        });
                        fetchedSubcategories.push(subcategoryData);
                    }
                    categoryData.subcategories = fetchedSubcategories;
                    fetchedCategories.push(categoryData);
                }
                allCategories = fetchedCategories; // Atualiza o array global de categorias
                renderAdminPanel(); // Renderiza o painel de administração com os dados mais recentes
                renderPublicView(); // Renderiza a visualização pública
            }, (error) => {
                console.error("Erro ao ouvir categorias: ", error);
                publicLoadingMessage.textContent = 'Erro ao carregar dados em tempo real.';
                publicNoLinksMessage.classList.remove('hidden');
                publicLoadingMessage.classList.add('hidden');
            });
        }

        // --- Event Listeners ---
        addCategoryBtn.addEventListener('click', addCategory);
        addSubcategoryBtn.addEventListener('click', addSubcategory);
        addLinkBtn.addEventListener('click', addLink);
        
        // Event listeners para as novas abas de navegação
        tabEncontrarLinks.addEventListener('click', (e) => {
            e.preventDefault();
            showTab('encontrar-links');
        });

        tabIndicarLinks.addEventListener('click', (e) => {
            e.preventDefault();
            showTab('indicar-links');
        });

        // Event Listener para o botão de rolagem para o topo
        window.onscroll = function() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                backToTopBtn.style.display = "block";
            } else {
                backToTopBtn.style.display = "none";
            }
        };

        backToTopBtn.addEventListener('click', () => {
            document.body.scrollTop = 0; // Para Safari
            document.documentElement.scrollTop = 0; // Para Chrome, Firefox, IE e Opera
        });

        // Inicializa o Firebase e começa a ouvir os dados
        setupFirebase();
        // Exibe a aba "Encontrar Links" por padrão ao carregar
        showTab('encontrar-links');
    </script>
</body>
</html>
