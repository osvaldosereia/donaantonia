<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Montador de Prompt — MeuJus</title>

<!-- =========================
     TEMA CLARO + DESIGN SYSTEM
     ========================= -->
<style>
  :root{
    --bg:#f7f8fb; --surface:#ffffff; --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb;
    --primary:#2563eb; --primary-ink:#ffffff; --accent:#10b981; --warn:#f59e0b; --danger:#ef4444;
    --radius:12px; --radius-sm:10px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    --sans: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Helvetica Neue", sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 var(--sans);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .mt-app{min-height:100vh;display:grid;grid-template-rows:auto 1fr}
  .mt-topbar{background:var(--surface);border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:10px 16px;position:sticky;top:0;z-index:5}
  .mt-topbar h1{margin:0;font-size:16px;font-weight:700;letter-spacing:.2px}
  .mt-actions{display:flex;gap:8px;align-items:center}
  .mt-wrap{display:grid;gap:12px;padding:12px 16px;grid-template-columns:300px 1fr 380px}
  .mt-panel{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);display:flex;flex-direction:column;min-height:0}
  .mt-head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
  .mt-head h2{margin:0;font-size:14px;font-weight:700}
  .mt-subhead{color:var(--muted);font-size:12px;margin-left:auto}
  .mt-body{padding:12px 14px;overflow:auto}
  .mt-footer{padding:10px 14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end;background:linear-gradient(180deg,rgba(255,255,255,.6),#fff)}
  .mt-input,.mt-select,.mt-textarea{width:100%;background:#fff;color:var(--ink);border:1px solid var(--line);border-radius:var(--radius-sm);padding:8px 10px;outline:none}
  .mt-input:focus,.mt-select:focus,.mt-textarea:focus{border-color:#cbd5e1;box-shadow:0 0 0 3px rgba(37,99,235,.12)}
  .mt-textarea{min-height:84px;resize:vertical}
  .mt-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .mt-kv{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center;margin-bottom:8px}
  .mt-kv label{color:var(--muted);font-size:12px}
  .mt-list{display:flex;flex-direction:column;gap:10px}
  .mt-item{border:1px solid var(--line);border-radius:var(--radius);padding:10px;background:#fff}
  .mt-title{margin:0 0 2px 0;font-weight:700;font-size:13px}
  .mt-sub{margin:0 0 6px;color:var(--muted);font-size:12px}
  .mt-tools{display:flex;gap:6px;flex-wrap:wrap}
  .mt-badge{background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;padding:2px 8px;border-radius:999px;font-size:11px}
  .mt-empty{color:var(--muted);text-align:center;padding:24px;border:1px dashed var(--line);border-radius:var(--radius)}
  .mt-btn{appearance:none;cursor:pointer;border:1px solid var(--line);background:#fff;color:var(--ink);padding:8px 10px;border-radius:var(--radius-sm)}
  .mt-btn:hover{background:#f8fafc}
  .mt-btn.primary{background:var(--primary);border-color:var(--primary);color:var(--primary-ink)}
  .mt-btn.ghost{background:transparent}
  .mt-btn.danger{border-color:#fecaca;background:#fff5f5;color:#991b1b}
  .mt-tabs{display:flex;gap:8px;margin-bottom:10px}
  .mt-tab{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-size:12px}
  .mt-tab.active{background:#e0ecff;border-color:#c7d2fe}
  .mt-code{white-space:pre-wrap;background:#f8fafc;color:#0f172a;border:1px solid var(--line);border-radius:var(--radius);padding:12px;font-family:var(--mono);font-size:12.5px}
  .mt-sep{height:1px;background:#e5e7eb;margin:10px -10px}
  @media (max-width:1180px){.mt-wrap{grid-template-columns:1fr;grid-auto-rows:minmax(260px,auto)}.mt-kv{grid-template-columns:1fr}.mt-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="mt-app">

  <!-- TOPBAR -->
  <header class="mt-topbar" role="banner">
    <h1>Montador de Prompt — Inicial Trabalhista</h1>
    <div class="mt-actions">
      <a class="mt-btn" href="/">Voltar ao site</a>
      <a class="mt-btn primary" href="/montador/">Reiniciar</a>
    </div>
  </header>

  <!-- LAYOUT -->
  <main class="mt-wrap" role="main">
    <!-- Catálogo -->
    <section class="mt-panel" aria-labelledby="h-cat">
      <div class="mt-head">
        <h2 id="h-cat">Catálogo</h2>
        <span class="mt-subhead">Selecione e adicione ao Canvas</span>
      </div>
      <div class="mt-body">
        <div class="mt-kv">
          <label for="catSearch">Buscar</label>
          <input id="catSearch" class="mt-input" placeholder="Digite para filtrar por título ou categoria" />
        </div>
        <div id="catFilters" class="mt-tools" style="margin-bottom:8px"></div>
        <div id="catList" class="mt-list"></div>
      </div>
    </section>

    <!-- Canvas -->
    <section class="mt-panel" aria-labelledby="h-canvas">
      <div class="mt-head">
        <h2 id="h-canvas">Canvas</h2>
        <span class="mt-badge" id="countBadge">0 blocos</span>
        <span class="mt-subhead">Ordene e edite seus blocos</span>
      </div>
      <div class="mt-body">
        <div id="canvasList" class="mt-list"></div>
        <div id="canvasEmpty" class="mt-empty">Nenhum bloco adicionado. Use o Catálogo à esquerda.</div>
      </div>
      <div class="mt-footer">
        <button class="mt-btn" id="btnClear" title="Remover todos os blocos">Limpar</button>
        <button class="mt-btn" id="btnImport" title="Importar projeto .json">Importar .json</button>
        <button class="mt-btn" id="btnPreview" title="Atualizar preview">Atualizar Preview</button>
        <button class="mt-btn" id="btnExportTxt" title="Exportar prompt .txt">Exportar .txt</button>
        <button class="mt-btn primary" id="btnExportJson" title="Salvar projeto .json">Salvar .json</button>
      </div>
    </section>

    <!-- Propriedades & Preview -->
    <section class="mt-panel" aria-labelledby="h-props">
      <div class="mt-head">
        <h2 id="h-props">Propriedades & Preview</h2>
        <span class="mt-subhead">Dados do caso, bloco e saída</span>
      </div>
      <div class="mt-body">
        <div class="mt-tabs" role="tablist" aria-label="Abas de edição">
          <button class="mt-tab active" data-tab="case" role="tab" aria-selected="true">Caso</button>
          <button class="mt-tab" data-tab="block" role="tab">Bloco</button>
          <button class="mt-tab" data-tab="preview" role="tab">Preview</button>
        </div>

        <!-- Aba: Caso -->
        <div id="tab-case">
          <div class="mt-kv"><label>Rito</label><select id="caseRito" class="mt-select">
            <option value="sumaríssimo">sumaríssimo</option><option value="ordinário">ordinário</option></select></div>
          <div class="mt-kv"><label>Competência</label><input id="caseComp" class="mt-input" placeholder="Ex.: Vara do Trabalho de Cuiabá/MT"></div>
          <div class="mt-kv"><label>Categoria/CBO</label><input id="caseCat" class="mt-input" placeholder="Ex.: Bancário / 4121-10"></div>
          <div class="mt-kv"><label>Sindicato/Data-base</label><input id="caseSind" class="mt-input" placeholder="Ex.: SEEB / 01-09"></div>
          <div class="mt-kv"><label>Vínculo</label><input id="caseVinc" class="mt-input" placeholder="CLT, experiência, temporário..."></div>
          <div class="mt-grid">
            <div class="mt-kv"><label>Admissão</label><input id="caseAdm" class="mt-input" placeholder="YYYY-MM-DD"></div>
            <div class="mt-kv"><label>Saída</label><input id="caseSai" class="mt-input" placeholder="YYYY-MM-DD"></div>
          </div>
          <div class="mt-grid">
            <div class="mt-kv"><label>Função</label><input id="caseFunc" class="mt-input" placeholder="Ex.: Operador de Caixa"></div>
            <div class="mt-kv"><label>Salário</label><input id="caseSal" class="mt-input" placeholder="Ex.: 2500"></div>
          </div>
          <div class="mt-kv" style="grid-template-columns:1fr">
            <textarea id="caseObs" class="mt-textarea" placeholder="Observações globais (opcional)"></textarea>
          </div>
          <div class="mt-kv"><label>LGPD (anonimizar)</label>
            <select id="caseLgpd" class="mt-select">
              <option>true</option><option>false</option>
            </select>
          </div>
        </div>

        <!-- Aba: Bloco -->
        <div id="tab-block" style="display:none">
          <div id="blockPanelEmpty" class="mt-empty">Selecione um bloco no Canvas para editar.</div>
          <div id="blockPanel" style="display:none">
            <div class="mt-kv"><label>Título</label><input id="blkTitulo" class="mt-input"></div>
            <div class="mt-kv"><label>Categoria</label><input id="blkCat" class="mt-input" disabled></div>
            <div class="mt-kv"><label>Variação</label><select id="blkVar" class="mt-select"></select></div>
            <div class="mt-kv"><label>Funções</label><div id="blkFuncs" class="mt-tools"></div></div>

            <div class="mt-sep"></div>
            <div class="mt-kv" style="grid-template-columns:1fr"><label style="font-weight:700">Subblocos</label></div>
            <div id="blkChildren" class="mt-list"></div>

            <div class="mt-sep"></div>
            <div id="blkFields" class="mt-list" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- Aba: Preview -->
        <div id="tab-preview" style="display:none">
          <div class="mt-actions" style="justify-content:flex-start; margin-bottom:8px">
            <button class="mt-btn" id="btnCopy">Copiar</button>
          </div>
          <div id="previewOut" class="mt-code" aria-label="Código do prompt"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<input type="file" id="fileImport" accept=".json" hidden />

<!-- ======================
     LÓGICA DO EDITOR (JS)
     ====================== -->
<script>
/* ========= Catálogo (com children) ========= */
const MT_CATALOG = {
  schemaVersion: 1,
  categories: ["Preâmbulo","Preliminares/Processo","Fatos do Contrato","Jornada","Pedidos/Conclusão"],
  blocks: [
    {
      id:"preambulo_basico",
      categoria:"Preâmbulo",
      titulo:"Preâmbulo – Endereçamento/Qualificação",
      resumo:"Endereçamento à Vara, qualificação das partes e objeto/rito.",
      campos:[
        {name:"vara",label:"Vara do Trabalho",type:"text"},
        {name:"cidade",label:"Cidade/UF",type:"text"},
        {name:"partes",label:"Resumo das Partes",type:"text"}
      ],
      variacoes:["mínimo","completo","combativo"],
      funcoes:["juris=false","lgpd=true","formato=forense"],
      objetivo:"Abrir a peça e qualificar as partes com rito indicado.",
      parametros:"vara={{vara}}, cidade={{cidade}}, partes={{partes}}",
      teses:"—"
    },
    {
      id:"preliminar_justica_gratuita",
      categoria:"Preliminares/Processo",
      titulo:"Preliminar – Justiça Gratuita",
      resumo:"Requer justiça gratuita com base legal.",
      campos:[ {name:"fundamento",label:"Fundamento complementar (opcional)",type:"text"} ],
      variacoes:["mínimo","completo","combativo"],
      funcoes:["juris=false","lgpd=true","formato=forense"],
      objetivo:"Pleitear concessão da gratuidade com base na hipossuficiência.",
      parametros:"fundamento={{fundamento}}",
      teses:"hipossuficiencia"
    },
    {
      id:"fatos_contrato_basico",
      categoria:"Fatos do Contrato",
      titulo:"Fatos – Contrato, Função e Condições",
      resumo:"Linha do tempo do vínculo e condições de trabalho.",
      campos:[
        {name:"jornada_contratual",label:"Jornada Contratual",type:"text"},
        {name:"beneficios",label:"Benefícios (VR/VA/Plano)",type:"text"}
      ],
      variacoes:["mínimo","completo","combativo"],
      funcoes:["juris=false","lgpd=true","formato=forense"],
      objetivo:"Descrever vínculo, função e condições do trabalho.",
      parametros:"jornada_contratual={{jornada_contratual}}; beneficios={{beneficios}}",
      teses:"—"
    },
    {
      id:"jornada_horas_extras",
      categoria:"Jornada",
      titulo:"Horas Extras e Intervalos",
      resumo:"Sobrejornada, intrajornada/interjornada, DSR/feriados.",
      campos:[
        {name:"jornada_real",label:"Jornada Real",type:"text"},
        {name:"he_semana",label:"Horas extras semanais (aprox.)",type:"number"},
        {name:"intrajornada_min",label:"Minutos suprimidos (intrajornada)",type:"number"}
      ],
      variacoes:["mínimo","completo","combativo"],
      funcoes:["juris=true","lgpd=true","formato=forense"],
      objetivo:"Demonstrar sobrejornada e pleitear pagamento com reflexos.",
      parametros:"jornada_real={{jornada_real}}; he_semana={{he_semana}}; intrajornada={{intrajornada_min}}",
      teses:"banco_horas_invalido; ponto_britanico; supressao_intervalo",
      children:[
        {
          id:"intrajornada",
          titulo:"Subbloco – Intervalo intrajornada",
          variacoes:["mínimo","completo"],
          funcoes:["juris=false"],
          campos:[{name:"intrajornada_min_det",label:"Minutos suprimidos (detalhe)",type:"number"}],
          objetivo:"Caracterizar supressão parcial do intervalo.",
          parametros:"intrajornada={{intrajornada_min_det}}",
          children:[
            {
              id:"base_calculo",
              titulo:"Sub-subbloco – Base de cálculo",
              variacoes:["mínimo","completo"],
              funcoes:[],
              campos:[{name:"base",label:"Base (salário, norma coletiva…)",type:"text"}],
              objetivo:"Definir base de cálculo e reflexos.",
              parametros:"base={{base}}"
            }
          ]
        },
        {
          id:"interjornada",
          titulo:"Subbloco – Intervalo interjornada (11h)",
          variacoes:["mínimo","completo"],
          funcoes:["juris=false"],
          campos:[],
          objetivo:"Descumprimento das 11h entre jornadas.",
          parametros:""
        }
      ]
    },
    {
      id:"pedidos_conclusao",
      categoria:"Pedidos/Conclusão",
      titulo:"Pedidos e Conclusão",
      resumo:"Listagem de pedidos e fecho.",
      campos:[
        {name:"valor_causa",label:"Valor da Causa (estimado)",type:"text"},
        {name:"cidade_data",label:"Local/Data",type:"text"}
      ],
      variacoes:["mínimo","completo","combativo"],
      funcoes:["juris=false","lgpd=true","formato=forense"],
      objetivo:"Consolidar pedidos, valor da causa e fecho.",
      parametros:"valor_causa={{valor_causa}}; cidade_data={{cidade_data}}",
      teses:"sucessivos_alternativos"
    }
  ]
};

/* ========= Estado ========= */
const MT = {
  catalog: MT_CATALOG,
  draft: { version:2, case:{ lgpd:true }, blocks:[] },
  selectedIdx: -1,
  qs: (q,el=document)=>el.querySelector(q),
  qsa:(q,el=document)=>Array.from(el.querySelectorAll(q)),
  storageKey: 'mt:draft:v2'
};

/* ========= Helpers ========= */
function cloneNodeFromDef(def){
  const node = {
    cid: crypto.randomUUID(),
    id: def.id,
    titulo: def.titulo,
    categoria: def.categoria,
    variacao: (def.variacoes?.[0]) || 'mínimo',
    funcoes: (def.funcoes||[]).slice(),
    campos: (def.campos||[]).map(c=>({name:c.name,label:c.label,type:c.type,value:''})),
    meta:{objetivo:def.objetivo||'', parametros:def.parametros||'', teses:def.teses||''},
    enabled: !!def.categoria, // raiz sempre incluída
    children: []
  };
  if(Array.isArray(def.children)){
    node.children = def.children.map(ch=>{ const n=cloneNodeFromDef(ch); n.enabled=false; return n; });
  }
  return node;
}

/* ========= Catálogo ========= */
function renderCatalog(filter=''){
  const list = MT.qs('#catList'); list.innerHTML='';
  const f = (filter||'').toLowerCase().trim();

  const chips = MT.qs('#catFilters'); chips.innerHTML='';
  MT.catalog.categories.forEach(cat=>{
    const b = document.createElement('button');
    b.className='mt-btn'; b.textContent=cat;
    b.onclick=()=> renderCatalog(cat);
    chips.appendChild(b);
  });

  MT.catalog.blocks
    .filter(b=> !filter || b.categoria===filter || b.titulo.toLowerCase().includes(f))
    .forEach(b=>{
      const it = document.createElement('div'); it.className='mt-item';
      it.innerHTML = `
        <h3 class="mt-title">${b.titulo}</h3>
        <p class="mt-sub">${b.categoria} · ${b.resumo||''}</p>
        <div class="mt-tools">
          <button class="mt-btn primary" data-add="${b.id}">Adicionar</button>
          <span class="mt-badge">variações: ${b.variacoes?.length||0}</span>
        </div>`;
      list.appendChild(it);
    });

  list.onclick = (e)=>{
    const id = e.target?.dataset?.add; if(!id) return;
    const block = MT.catalog.blocks.find(x=>x.id===id);
    if(!block) return;
    const clone = cloneNodeFromDef(block);
    MT.draft.blocks.push(clone);
    saveDraft(); renderCanvas(); selectBlock(MT.draft.blocks.length-1);
  };

  MT.qs('#catSearch').oninput = (e)=> renderCatalog(e.target.value);
}

/* ========= Canvas ========= */
function renderCanvas(){
  const list = MT.qs('#canvasList'); list.innerHTML='';
  const empty = MT.qs('#canvasEmpty');
  MT.qs('#countBadge').textContent = `${MT.draft.blocks.length} blocos`;
  empty.style.display = MT.draft.blocks.length? 'none':'block';

  MT.draft.blocks.forEach((b,idx)=>{
    const el = document.createElement('div'); el.className='mt-item';
    el.style.outline = (idx===MT.selectedIdx)? '2px solid rgba(37,99,235,.35)':'none';
    el.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px">
        <div>
          <div class="mt-title">${b.titulo}</div>
          <div class="mt-sub">${b.categoria||'—'} · variação: <b>${b.variacao}</b></div>
        </div>
        <div class="mt-tools">
          <button class="mt-btn" data-act="sel">Editar</button>
          <button class="mt-btn" data-act="up">↑</button>
          <button class="mt-btn" data-act="down">↓</button>
          <button class="mt-btn" data-act="dup">Duplicar</button>
          <button class="mt-btn danger" data-act="del">Remover</button>
        </div>
      </div>`;
    el.onclick = (e)=>{
      const act = e.target?.dataset?.act;
      if(!act){ selectBlock(idx); return; }
      if(act==='sel'){ selectBlock(idx); }
      if(act==='up' && idx>0){ [MT.draft.blocks[idx-1], MT.draft.blocks[idx]]=[MT.draft.blocks[idx], MT.draft.blocks[idx-1]]; saveDraft(); renderCanvas(); selectBlock(idx-1); }
      if(act==='down' && idx<MT.draft.blocks.length-1){ [MT.draft.blocks[idx+1], MT.draft.blocks[idx]]=[MT.draft.blocks[idx], MT.draft.blocks[idx+1]]; saveDraft(); renderCanvas(); selectBlock(idx+1); }
      if(act==='dup'){ const copy=JSON.parse(JSON.stringify(MT.draft.blocks[idx])); copy.cid=crypto.randomUUID(); MT.draft.blocks.splice(idx+1,0,copy); saveDraft(); renderCanvas(); selectBlock(idx+1); }
      if(act==='del'){ MT.draft.blocks.splice(idx,1); MT.selectedIdx=-1; saveDraft(); renderCanvas(); renderBlockPanel(); }
    };
    list.appendChild(el);
  });
}

/* ========= Aba: Caso ========= */
function bindCase(){
  const g = { rito:'#caseRito', comp:'#caseComp', cat:'#caseCat', sind:'#caseSind',
    vinc:'#caseVinc', adm:'#caseAdm', sai:'#caseSai', func:'#caseFunc', sal:'#caseSal', obs:'#caseObs', lgpd:'#caseLgpd' };
  const set=(k,sel)=> MT.qs(sel).value = MT.draft.case[k] ?? '';
  Object.entries(g).forEach(([k,sel])=> set(k,sel));
  MT.qs(g.lgpd).value = String(MT.draft.case.lgpd ?? 'true');

  const upd=(k,sel,ev='input')=> MT.qs(sel).addEventListener(ev,()=>{ MT.draft.case[k]=MT.qs(sel).value; saveDraft(); });
  Object.entries(g).forEach(([k,sel])=> upd(k,sel, k==='lgpd'?'change':'input'));
}

/* ========= Aba: Bloco ========= */
function selectBlock(idx){ MT.selectedIdx=idx; renderCanvas(); renderBlockPanel(); MT.qs('[data-tab="block"]').click(); }

function renderChildrenEditor(node, def){
  const wrap = MT.qs('#blkChildren'); wrap.innerHTML='';
  if(!node.children?.length) return;

  const makeRow = (n, d, level=0) => {
    const row = document.createElement('div');
    row.className='mt-item';
    row.style.marginLeft = (level*12)+'px';
    row.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div>
          <div class="mt-title">${n.titulo}</div>
          <div class="mt-sub">variação: <b>${n.variacao}</b>${n.enabled?' · incluído':''}</div>
        </div>
        <div class="mt-tools">
          <label class="mt-btn">
            <input type="checkbox" ${n.enabled?'checked':''} data-k="en"/> Incluir
          </label>
          <select class="mt-select" data-k="var"></select>
          <button class="mt-btn" data-k="edit">Campos</button>
        </div>
      </div>
      <div class="mt-list" data-k="children"></div>
    `;
    const sel = row.querySelector('select[data-k="var"]');
    (d.variacoes||['mínimo']).forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent=v; if(v===n.variacao) o.selected=true; sel.appendChild(o);
    });
    sel.onchange = ()=>{ n.variacao=sel.value; saveDraft(); renderBlockPanel(); };

    const chk = row.querySelector('input[data-k="en"]');
    chk.onchange = ()=>{ n.enabled = chk.checked; saveDraft(); };

    row.querySelector('button[data-k="edit"]').onclick = ()=>{
      MT.qs('#blkFields').innerHTML='';
      (n.campos||[]).forEach((c,i)=>{
        const rr = document.createElement('div'); rr.className='mt-kv';
        rr.innerHTML = `<label>${c.label||c.name}</label>`+
          (c.type==='textarea'
            ? `<textarea data-idx="${i}" class="mt-textarea" placeholder="${c.name}">${c.value||''}</textarea>`
            : `<input data-idx="${i}" class="mt-input" placeholder="${c.name}" value="${c.value||''}">`);
        MT.qs('#blkFields').appendChild(rr);
      });
      MT.qs('#blkFields').oninput = (e)=>{
        const el=e.target, i=+el.dataset.idx;
        if(Number.isFinite(i)){ n.campos[i].value = el.value; saveDraft(); }
      };
    };

    if(n.children?.length){
      const slot=row.querySelector('[data-k="children"]');
      n.children.forEach(ch=>{
        const dch = (d.children||[]).find(x=>x.id===ch.id)||{};
        slot.appendChild(makeRow(ch, dch, level+1));
      });
    }
    return row;
  };

  node.children.forEach(ch=>{
    const d = (def.children||[]).find(x=>x.id===ch.id)||{};
    wrap.appendChild(makeRow(ch,d,0));
  });
}

function renderBlockPanel(){
  const empty = MT.qs('#blockPanelEmpty'), panel = MT.qs('#blockPanel');
  if(MT.selectedIdx<0){ empty.style.display='block'; panel.style.display='none'; return; }
  const b = MT.draft.blocks[MT.selectedIdx];
  empty.style.display='none'; panel.style.display='block';

  MT.qs('#blkTitulo').value = b.titulo;
  MT.qs('#blkCat').value   = b.categoria||'';

  const vSel = MT.qs('#blkVar'); vSel.innerHTML='';
  const orig = MT.catalog.blocks.find(x=>x.id===b.id);
  (orig.variacoes||['mínimo']).forEach(v=>{
    const o=document.createElement('option'); o.value=v; o.textContent=v; if(v===b.variacao) o.selected=true; vSel.appendChild(o);
  });
  vSel.onchange=()=>{ b.variacao=vSel.value; saveDraft(); renderCanvas(); };

  const fWrap = MT.qs('#blkFuncs'); fWrap.innerHTML='';
  (orig.funcoes||[]).forEach(f=>{
    const [key,val] = f.split('=');
    const current = (b.funcoes.find(x=>x.startsWith(key+'='))||f).split('=')[1];
    const btn = document.createElement('button');
    btn.className='mt-btn'; btn.textContent = `${key}=${current}`;
    btn.onclick=()=>{
      const i = b.funcoes.findIndex(x=>x.startsWith(key+'='));
      const next = (current==='true')?'false':'true';
      const pair = `${key}=${next}`;
      if(i>=0) b.funcoes[i]=pair; else b.funcoes.push(pair);
      saveDraft(); renderBlockPanel();
    };
    fWrap.appendChild(btn);
  });

  // Subblocos
  renderChildrenEditor(b, orig);

  // Campos do bloco raiz
  const fld = MT.qs('#blkFields'); fld.innerHTML='';
  (b.campos||[]).forEach((c,i)=>{
    const row = document.createElement('div'); row.className='mt-kv';
    row.innerHTML = `<label>${c.label||c.name}</label>`+
      (c.type==='textarea'
        ? `<textarea data-idx="${i}" class="mt-textarea" placeholder="${c.name}">${c.value||''}</textarea>`
        : `<input data-idx="${i}" class="mt-input" placeholder="${c.name}" value="${c.value||''}">`);
    fld.appendChild(row);
  });
  fld.oninput = (e)=>{
    const el=e.target, i=+el.dataset.idx;
    if(Number.isFinite(i)){ b.campos[i].value = el.value; saveDraft(); }
  };
  MT.qs('#blkTitulo').oninput = ()=>{ b.titulo = MT.qs('#blkTitulo').value; saveDraft(); renderCanvas(); };
}

/* ========= Preview ========= */
function headerPrompt(){
  const C = MT.draft.case, val = (v)=> (v && String(v).trim()) ? String(v).trim() : '[DADO A SER CONFIRMADO]';
  return [
`Você é ADVOGADO ESPECIALISTA EM DIREITO DO TRABALHO no Brasil.
Objetivo: redigir peça processual inicial trabalhista completa, observando técnica, lei e jurisprudência.
Estilo: linguagem forense, clara, coesa, sem adjetivações desnecessárias.
Formatação: títulos, numeração, pedidos itemizados, valor da causa, local/data e assinatura.
Fontes: CLT, CF/88, leis, súmulas/OJs TST, jurisprudência colegiada recente. Cite links de sites oficiais ou repositórios reconhecidos.
LGPD: ${val(C.lgpd ?? 'true')}.
Se algo faltar, assuma dados plausíveis e marque com “[DADO A SER CONFIRMADO]”.

Dados do Caso (globais):
- Rito: ${val(C.rito)} | Competência: ${val(C.comp)}
- Categoria/CBO: ${val(C.cat)} | Sindicato/Data-base: ${val(C.sind)}
- Contrato: ${val(C.vinc)} | Admissão: ${val(C.adm)} | Saída: ${val(C.sai)}
- Função: ${val(C.func)} | Salário: ${val(C.sal)}
- Observações gerais: ${val(C.obs)}`
].join('\n');
}

function renderNode(node, def){
  const map = Object.fromEntries((node.campos||[]).map(c=>[c.name, c.value||'']));
  const repl = (tpl)=> tpl ? tpl.replace(/\{\{(\w+)\}\}/g,(_,k)=> (map[k] && String(map[k]).trim()) ? String(map[k]).trim() : '[DADO A SER CONFIRMADO]') : '';

  const fun = Object.fromEntries((node.funcoes||[]).map(s=>{ const [k,v]=s.split('='); return [k,v]; }));
  const juris = String(fun['juris']||'false')==='true';

  let out = [
`### BLOCO: ${node.titulo}${node.categoria?` (Categoria: ${node.categoria})`:''}
Objetivo do Bloco:
- ${def.objetivo||'—'}

Entradas Específicas:
- Fatos-chave: ${repl(def.resumo||'—')}
- Parâmetros: ${repl(def.parametros||'—')}
- Tese(s) pretendida(s): ${def.teses||'—'}

Instruções à IA:
1) Contextualize brevemente com o caso global.
2) Fundamente com CLT/CF/leis/Súmulas/OJs pertinentes${juris?'; inclua 2–4 precedentes colegiados recentes':''}.
3) Explique base de cálculo e reflexos (se aplicável), sem fazer cálculos numéricos.
4) Redação pronta para colar (parágrafos coesos).
5) Tom técnico e conciso; evite repetição.

Parâmetros Opcionais:
- jurisprudencia: ${juris}; lgpd_anonimizar: ${String(MT.draft.case.lgpd ?? 'true')}
- variacao: ${node.variacao||'mínimo'}

Saída Esperada (do bloco):
- Título sintético
- 1–3 parágrafos coesos
${juris?'- Precedentes (links oficiais) ao final do bloco':''}`
  ].join('\n');

  if (node.children?.length){
    node.children.forEach(ch=>{
      if(ch.enabled){
        const d = (def.children||[]).find(x=>x.id===ch.id)||{};
        out += '\n\n' + renderNode(ch,d);
      }
    });
  }
  return out;
}

function buildPrompt(){
  const parts = [headerPrompt()];
  MT.draft.blocks.forEach(b=>{
    const def = MT.catalog.blocks.find(x=>x.id===b.id) || {};
    parts.push(renderNode(b, def));
  });
  return parts.join('\n\n');
}

function renderPreview(){ MT.qs('#previewOut').textContent = buildPrompt(); }

/* ========= Persistência & IO ========= */
function saveDraft(){ try{ localStorage.setItem(MT.storageKey, JSON.stringify(MT.draft)); }catch(e){} }
function loadDraft(){
  try{
    const raw=localStorage.getItem(MT.storageKey);
    MT.draft = raw ? JSON.parse(raw) : { version:2, case:{ lgpd:true }, blocks:[] };
  }catch(e){
    MT.draft = { version:2, case:{ lgpd:true }, blocks:[] };
  }
}
function download(filename, text){
  const a=document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text],{type:'text/plain'}));
  a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}
const exportTxt = ()=> download('prompt-trabalhista.txt', buildPrompt());
const exportJson= ()=> download('montador-projeto.json', JSON.stringify(MT.draft,null,2));
function importJson(file){
  const reader=new FileReader();
  reader.onload=()=>{ try{
    const obj=JSON.parse(reader.result);
    if(!obj || !Array.isArray(obj.blocks)) throw new Error('Estrutura inválida.');
    MT.draft=obj; MT.selectedIdx=-1; saveDraft(); renderCanvas(); renderBlockPanel(); alert('Projeto importado.');
  }catch(e){ alert('Falha ao importar: '+e.message); } };
  reader.readAsText(file);
}

/* ========= Abas ========= */
function bindTabs(){
  const tabs = MT.qsa('.mt-tab');
  tabs.forEach(t=> t.onclick = ()=>{
    tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
    const id=t.dataset.tab;
    MT.qs('#tab-case').style.display   = id==='case'   ? 'block':'none';
    MT.qs('#tab-block').style.display  = id==='block'  ? 'block':'none';
    MT.qs('#tab-preview').style.display= id==='preview'? 'block':'none';
    if(id==='preview') renderPreview();
  });
}

/* ========= Bootstrap ========= */
function init(){
  loadDraft();
  renderCatalog();
  renderCanvas();
  bindCase();
  bindTabs();
  MT.qs('#btnClear').onclick = ()=>{ if(confirm('Remover todos os blocos?')){ MT.draft.blocks=[]; MT.selectedIdx=-1; saveDraft(); renderCanvas(); renderBlockPanel(); } };
  MT.qs('#btnExportTxt').onclick = exportTxt;
  MT.qs('#btnExportJson').onclick= exportJson;
  MT.qs('#btnImport').onclick = ()=> MT.qs('#fileImport').click();
  MT.qs('#fileImport').onchange = (e)=>{ const f=e.target.files?.[0]; if(f) importJson(f); e.target.value=''; };
  MT.qs('#btnPreview').onclick = renderPreview;
  MT.qs('#btnCopy').onclick = ()=> navigator.clipboard.writeText(buildPrompt()).then(()=> alert('Prompt copiado.'));
}
init();
</script>
</body>
</html>
